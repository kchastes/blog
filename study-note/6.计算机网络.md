# 1. 概述

因特网由多个主机和路由器互联组成。网络->多个网络组成互联网->全世界最大的互联网：因特网

用户都是通过`ISP`获得`IP`地址接入互联网。`ISP`通过分层组织：

1.  第一层为主干网，负责国际性网络。

2. 第二层为区域性或国家性覆盖，一些大公司可以使用该服务。

3. 第三层为本地范围覆盖，主要用户为住宅用户，校园网企业网之类的用户。

当一台设备接入互联网，自身也可以成为一个`ISP`，只需要购买调制解调器和路由器进行关联。

因特网`ISOC`负责对因特网进行全面管理。指定因特网正式标准流程(并非所有`RFC`文档都能成为因特网标准)：

1. 因特网草案(此时还不是`RFC`文档)。
2. 建议标准(开始成为`RFC`文档)。
3. 草案标准。
4. 因特网标准。

计算机网络简单定义: 互联、自治、集合。

广域网: `WAN`，局域网: `LAN` ，

## 1.1 数据交换

|          |                             步骤                             |                             优点                             |                             缺点                             |
| :------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| 电路交换 | 1. 分配通信资源，该资源不会被其他通信占用。<br />2. 通信   <br />3. 释放连接、通信资源 | 1. 时延小<br />2.有序传输<br />3. 不会造成链路冲突<br />4. 实时 | 1. 连接时间长<br />2. 信道利用率低<br />3. 灵活性差(数据控制) |
| 分组交换 | 1. 将数据划分成小段，并添加首部<br />2. 交换机根据首部查表转发<br />3. 到达目的地分组拆解(去首部)、合并 |                1. 线路效率高<br />2. 灵活性好                | 1. 存在转发时延<br />2. 数据量变大(首部)<br />3.数据出错率大 |

## 1.2 性能指标

计算机性能指标：速率、带宽、吞吐量、时延、时延带宽积、往返时间、利用率、丢包率。

1. **速率**

   速率就是主机在信道上传送**比特**的速率。硬盘较小的原因：计算机内存使用1024制，而硬盘和网速使用1000制。1024制中间应该加上i。但是1字节等于8比特不受影响，也就是说bit/s表示比特，B/s表示字节。
   
   数据单位：
   
   ​	千字节(`KiB`)：一个千字节等于1024个字节。1`KiB`= 1024`Byte`。   ​      
   
   ​	兆字节(`MiB`)：一个兆字节等于于1024个千字节。1`MiB`= 1024`KiB`。   ​    
   
   ​	吉字节(`GiB`)：一个吉字节等于1024个兆字节。1`GiB`= 1024`MiB`。   ​     
   
   ​	太字节(`TiB`)：一个太字节等于1024个吉字节。1`TiB`=1024`GiB`。   
   
   
   常用的速率单位有(1000制，1024对应为Kibit/s，Mibit/s，Gibit/s，Tibit/s)：
   
   ​	kbit/s (kb/s，kbps)：千比特每秒，表示1000个比特。1kbit/s = 1000 bit/s。   
   
   ​	Mbit/s (Mb/s，Mbps)：兆比特每秒, 1Mbit/s = 1000kbit/s。   	   
   
   ​	Gbit/s (Gb/s，Gbps) ：吉比特每秒，1Gbit/s = 1000Mbit/s。     
   
   ​	Tbit/s(Tb/s，Tbps)：太比特每秒，1Tbit/s = 1000Gbit/s。
   
2. **带宽**

   带宽表示在单位时间内，从一点到另一点能通过的最高速率。

3. **吞吐量**

   吞吐量表示单位时间内，通过网络接口或信道的数量。

4. **时延(主导时延应具体分析)**

   发送时延：主机将数据发送出去的时延。（受木桶最短的一块板影响）

   传播时延：分组在路径上传输的时延。

   处理时延：路由器进行存储转发的时延。

5. **往返时间(RTT)**

   分组发送到接收到分组确认时的时间。

6. **丢包率**

   指在一定时间范围内，丢包的数量和总数量的比率。丢弃的原因：1.数据出现误码，被丢弃。2.分组队列已满，被丢弃

## 1.3 分层

网络分层具有多种分法：

1. **OSI七层**(法律上的国际标准)：

   物理层，链路层，网络层，运输层，会话层，表示层，应用层

2. **事实上的国际标准TCP/IP体系结构** (IP和TCP起着重要作用) ：

   网络接口层，网际层，运输层，应用层

3. **为了便于学习所推出的五层体系结构**:

   物理层(比特流)，链路层(帧)，网络层(数据报)，运输层(报文段)，应用层(报文)

OSI七层失败的原因：1.专家缺乏经验，大多不符合实际。2. 协议实现复杂。3. 层次划分不合理，功能多处冗余。3. 实现复杂，效率低。

分层主要是将庞大的问题转为若干教小的问题，便于管理，灵活度更高。缺点：协议升级改造复杂，功能可能有所冗余。就跟让你用代码解决问题，是分类解决好，还是一处解决所有。

主机间的网络通信，就是主机中的应用进程基于网络进行通信。逐层拆解或封装。提交的都是比特流，但是在每一层赋予发不同意义。

# 2. 物理层

物理层就是要解决在不同传输媒体上传输0和1的问题。常见的传输媒体分两种：

| 导引型传输媒体 | 非导引型传输媒体(电磁波) |
| :------------: | :----------------------: |
|     双绞线     |         微波通信         |
|    同轴电缆    |         无线电波         |
|      光纤      |          红外线          |

物理协议主要从一下几个方面控制:

1. 机械特性：接线器的形状和尺寸，引脚数和排列等装置。
2. 电气特性：电压范围。
3. 功能特性：某种电压代表的意义。

LIFE通过控制灯光频率进行通信。

## 2.1 传输方式

1. 串行传输：比特依次排队发送，只需要一条传送线路即可(计算机网络采用)。
2. 并行传输：一次发送n个比特，需要多条线路(计算机内存使用总线)。
3. 同步传输：字节按照指定的时钟频率进行发送。
4. 异步传输：字节之间没有固定的时钟频率。
5. 单工通信：单向通信，只有一方发送数据。
6. 双向交替通信：半双工，双方可以相互交换数据，但是不能同时传递。
7. 双向同时通信：全双工，双方可以同时通信。

## 2.2 编码

数字信号使用调制，模拟信号使用编码。

1. 不归零编码：高低电平代表0或1，每次传输完不归0。需要而外的控制线进行时钟同步。
2. 归零编码：每次传输完都会归0。
3. 曼切斯特编码：通过传输一半时进行跳变，根据跳变区分0或1。

# 3. 链路层

指数据从一个节点到另一个节点，中间不经过其他节点。每一种数据链路层都规定了最大数据上限(MTU，不包含首部)

## 3.1 封装成帧

就是给上层交付的数据单元添加帧头和帧尾，使之成为帧。帧头和帧尾有着重要控制信息。帧头和帧尾的作用之一就是通过帧定界标志，可以提取出一个个的帧。但是并不是所有链路层协议的帧都有帧定界标志。

PPP帧的格式：

![image-20210812180712475](..\image\image-20210812180712475.png)

例如以太网V2帧就没有帧定界标志。

![image-20210812175635631](..\image\image-20210812175635631.png)

物理层给MAC帧添加8字节的前导码，前导码的前7个字节为前同步码，以进行时钟同步。后一个字节为帧开始定界符。以太网还规定了帧间间隔时间为96比特时间

**透明传输**

透明传输就是链路层对上层数据不做任何限制。如果不做限制，上层数据报包含帧定界值，对等实体方就无法划分帧。

面向字节的物理链路：数据链路层检测上层数据，发现一个帧定界标志，就再前面插入一个转义字符。在接收方时，将删除转义字符，并继续提取数据。如果上层数据既有帧定界标志，又有转义字符，依旧按上面的方式处理。

面向比特的物理链路：在连续的五个1后面插入一个比特0，提取数据时连续的五个1后去除比特0即可。

## 3.2 差错检测

在传输过程中，比特可能从0变为1，从1变为0，产生变化的值就为误码。在一段时间内产生的误码和传输的比特总数的比率即为误码率。

帧中的FCS就是用于接收方检测误码。

**奇偶校验**

在待发送的数据后面添加一位奇偶校验位。使整个数据中包含1的个数为奇数或偶数。奇偶校验对产生偶数个误码差错无法检测。

**循环冗余CRC**

双方约定多项式，发送方基于数据和多项式计算出冗余码，将其一起传输，接收方也通过多项式和数据计算冗余码，进行对比，判断是否出现误码。

检测码只能检测误码，不能纠正错误。

## 3.3 可靠数据服务

出现不可靠的原因主要有：比特差错，分组丢失，分组重复，分组失序。

不可靠数据服务：仅丢弃有误码的帧，而不进行任何处理。可靠数据服务：实现发送方发送什么，接收方就接收什么。

一般情况下，有线链路误码率比较低，并不要求链路层向上提供可靠数据服务，而无线链路存在较多干扰，需要向上层提供可靠数据服务。

### 3.3.1 停止等待(ARQ)

停止等待协议每次仅发送一个数据，收到接受方发送的确认分组后才发送洗一个分组。超时重传的时间略大于平均RTT。该可靠传输方式信道效率低。

![image-20210813135440552](..\image\image-20210813135440552.png)

数据序号的作用：用于接收方对重复的数据进行区分，接收方才知道是一个新的分组或者是一个旧的重传分组。

ACK确认分组序号作用：防止对确认ACK分组判断错误，而发送不应该发送的数据。例如：分组0发送，响应ACK0延迟，超时重发分组0，接收响应ACK0，发送分组1。此时的分组1不应该发送。

### 3.3.2 回退N帧

发送方和接收方维持一个发送窗口，接收方接收窗口大小只有1。在发送方的发送窗口的数据才可以进行发送。接收方可以采用累计确认的方式，即在收到几个分组后，对按序到达的最后一个分组发送确认ACK，表示该分组前的分组都已经正确收到。缺点就是不能及时像发送方反映接收方已经正确接收分组的信息

![image-20210813173748927](..\image\image-20210813173748927.png)

图1表示正常无差错情况，接收方每接收到一个就发送确认ACK，或者使用累计确认的方式。

图二表示出现差错后，将会丢弃发送的分组，同时对每个乱序的分组发送最近按序到达的分组ACK。连续收到多个ACK时(**冗余ACK**)，可以不等计时器超时重传，可以马上进行重传(**快速重传**)，其序号后面已发送的都需要进行重传。

如果窗口大小大于序号范围，则会出现无法区分分组是重传的，还是属于新分组。例如：接收方正确接收后，ACK分组丢失，发送方重发。

### 3.3.3 选择重传协议

回退N帧效率不高，接收窗口大小只有一。一个分组错误，会导致后续分组全部重传。

选择重传就是接收窗口大小不在限制为1，同时缓存未按序到达的分组。待数据集齐后再向上层交付。不能使用累计确认。

## 3.4 PPP点对点控制协议

![image-20210812180712475](..\image\image-20210812180712475.png)

1. 帧定界标志位：取值0x7E。
2. 地址：取值0xFF，目前没什么用。
3. 控制：取值0x03，目前没什么用。
4. 协议字段：表明数据报由何种协议处理。0x0021为IP数据报，0xC021为LCP分组，0x8021为NCP分组
5. FCS字段：为循环冗余CRC计算的校验位。

PPP解决透明传输的方式得看具体的传输方式，如果使用字节的链路，使用转义符。如果面向比特，则使用比特填充法。

## 3.5 MAC地址

通过MAC地址来区分数据的接收方。一般出现再网卡中(目前有随机MAC地址)，MAC地址是对网络上各接口的标识，而不是设备。

MAC地址由48个比特构成(6字节)，前三个字节由管理机构分配，后三个字节由厂商自行分配。标准写法是将每4个比特写成16进制的数，共12个，每两个中为一组，共6组(也可以4个一组)。FF-FF-FF-FF为广播地址，第一个字节最后一位为1则为多播地址。

MAC地址是链路间的，而IP地址是网络间的。参考问路。

MAC不具备区分不同网络的功能。MAC地址随着网络而改变。路由器根据MAC地址来选择路由进行数据发送.

## 3.6 地址解析协议ARP

通过IP地址寻找IP地址。高速缓存表记录有IP地址和MAC地址的对应关系。如果没有对应关系，需要发送ARP广播请求报文，对应主机收到后返回单拨响应数据。有动态和静态两种，该协议是独段链路使用的，不能跨链路。 

# 4.网络层

IP地址由32位组成，全世界唯一，IPv4地址已经分配完毕，现使用IPv6。

IP地址使用4字节表示，每一组一个字节。十进制数快速转换方法：7位最高位值位128，后续以此除2。十进制转二进制：用10进制数不断除以2，余数从后往前排就是二进制数。

ping使用了ICMP报文，受到该报文的必须发送ICMP回答报文。

## 4.1 分类编址

只有A、B、C类的地址可以分配给主机或路由器，主机号全为0的地址是网络地址，全1的是广播地址，不能分配给主机或路由器的接口。

0.0.0.0表示本网络的本主机。只能做为源地址使用。

1. A类

   网络号占8位，主机号占24位，最高位固定为0。最小网络号0，保留不指派。第一个可以指派的网络号为1，最小IP为1.0.0.0。最大网络号127用于回环测试，不指派。最小的环回测试地址：127.0.0.1，最大环回测试地址：127.255.255.254。因此最大可指派网络号为126。网络号范围1-126。

2. B类

   网络号和主机号各占16位，网络最高两位固定10。最小网络地址：128.0.0.0，最大网络号为191.255

3. C类

   网络号占24位，主机号占8位，网络号的最高三位固定110。最小网络号192.0.0，最大网络号223.255.255

4. D类

   为多播地址最高4位为1110。

5. E类

   为保留地址，最高四位1111。

## 4.2 划分子网

出现划分子网的原因：避免浪费IP地址，节省费用。通过子网掩码划分子网(二进制与运算)。定长划分子网掩码不太灵活，每个子网数量一致，使用变长子网掩码可以解决该问题。

## 4.3 无分类编址

通过/知道前几位为网络号，进而推出其他信息。网络前缀越长，地址块越小，路由越具体。路由选择最长一条。

## 4.4 IP数据报转发

通过子网掩码得知是否在同一网络，通过将数据报发送给默认网关。

1. 路由器先检测IP数据报是否出错，出错丢弃，未出错转发。
2. 根据目的地地址在路由表中选择路由。若没有对应路由，丢弃并告知。

路由器是隔离广播域的。如果配置的路由过多将影响效率，配置默认路由可以解决(0.0.0.0/0)。静态路由配置会倒置路由无限递归。通过设置过期时间TTL解决路由环路问题。如果存在不存在的网络由，则也会引发路由环路，通过设置黑洞路由解决，即置为null。

如果由于网络原因，会导致删除路由，从而选择默认路由，也会形成环路，也是通过配置黑洞路由进行处理，网络良好时会自动禁用，网络欠佳时自动启用。

转发表数据由路由表得出，如果转发表中没有对应的信息，则丢弃分组

## 4.5 RIP路由选择协议

RIP选择经过路由最少的路径，如果距离相等，则使用等价负载均衡。

# 5. 运输层

这种进行通信的是主机间的进程，端口号0-65535，0-1023分配给常用应用。FTP使用20/21，HTTP使用80，DNS使用53。

TCP只支持单播，UDP支持多播，广播，单播。超时重传时间在每次重传后都扩大2倍。

## 5.1 流量控制

发送方数据发送过快，接收方速度跟不上。通过控制窗口大小进行流控，如果收到0窗口通知，就启动计时器，计时器超时就发送一个零窗口探测报文，零窗口探测报文段也有超时计时器。

## 5.2 拥塞控制

对某一资源的需求超过了所能提供的部分，造成网络拥堵。发送方维护一个叫做拥塞窗口的的状态值，基于网络动态变换(尽量大)。判断网络拥塞的依据就是没有收到确认报文段。

### 5.2.1 慢开始

发送方维护一个发送量阈值，发送窗口小于该阈值时，使用慢开始算法。当窗口值大于阈值时，改为使用拥塞避免算法。阈值有一个默认的值，当发送方每收到一个对新报文段的确认时，发送窗口就翻倍。

### 5.2.2 拥塞避免

当发送大小等于阈值时，便进入拥塞避免，此时不会翻倍增长，改为加一。当发送超时重传时，则会将阈值变为最大窗口的一半，窗口值变为1，并重新开始慢开始算法。

超时重传会导致有时网络并网络并未发生拥塞，但误认为发送了拥塞，降低了传送效率。

### 5.2.3 快重传

如果收到三个连续的重复确认，就将相应的报文立刻重传，而不等待超时重传。使用了快重传机制，就不会导致对拥塞判断失误。从而进入快恢复环节。

### 5.2.4 快恢复

将阈值和窗口大小调整为当前窗口的一半，并执行拥塞避免。

## 5.3 TCP连接

建立连接主要是为了初始化一些值，使双方能够感知对方的存在，分配资源。

**连接**

TCP规定SYN为1的不能携带数据

![image-20210809144720177](C:\Users\Administrator\Desktop\blog\image\image-20210809144720177.png)

能否使用两报文建立连接？如果只用两次连接，第一个请求报文超时进行重传，待连接关闭后，延时的第一个报文到达，与服务器建立了连接，浪费服务器资源。防止已失效的TCP连接报文突然传送到了TCP服务器，进而浪费资源。

**关闭**

超时时间有不同的实现具体控制，四次挥手的目的就是因为连接时双向的，你没数据发了，可是别人还有数据要发。。

![image-20210809144820106](C:\Users\Administrator\Desktop\blog\image\image-20210809144820106.png)

为什么要等待？为了防止客户端发送的最后ACK丢失，导致服务器重传最后一个FIN报文段时无法进行接收而导致服务器无法关闭的问题。

TCP有保活计时器，没收到一次就重启保活计时器，到时发送探测报文，每隔75s发送一个，连续10个则关闭。

TCP报文的PSH表示尽快向上层交付。RST表示连接出现异常，重新建立连接。UGR为1时，紧急指针有效，为0无效。紧急数据将会排在前面。

# 流程

当在浏览器输入地址时：

1. 操作系统生成DNS报文查询IP地址(省略通过ARP过去MAC地址过程)。
2. 生成套接字，HTTP报文。
3. 与目的地址进行三次握手。
4. 连接成功后，进行发送数据。

# 6. 安全

凯撒密码对密文进行字母偏移，升级的单码代替密码使用对照字母进行替换加密。改进的就是多块进行循环替代。

**块密码**

要加密的内容被处理为只有K比特的块，对每块进行独立加密，该方法维护艰难。

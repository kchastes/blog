# 1. 导论

操作系统就是为用户程序提供更清晰简洁的计算机模型(**隐藏硬件细节，提供抽象模型**)，并管理底层设备(**提供硬件的资源分配**)。

![image-20210827110805517](..\image\image-20210827110805517.png)

多数计算机分两种运行模式，内核态和用户态，如上图所示。内核态具有对硬件的所有访问权，而用户态只使用部分命令子集。内核态和用户态区别就在于能否随意更换。大部分操作系统运行在内核态，程序在用户态，而嵌入式系统一部分系统运行在内核态。

操作系统在资源管理上采用**多路复用**，在空间和时间上复用，时间复用也就是时间片，而空间复用就是将空间划片。

## 1.1 计算机硬件

1. 处理器(CPU)

   处理器从内存中读取指令并执行，从内存中获取指令或数据比较长，CPU使用**通用寄存器**来保存关键变量或临时数据。**程序计数器**是一种对外界可见的寄存器，保存下一条将要执行的命令。**堆栈指针寄存器**，指向内存栈顶端。**程序字寄存器(PSW)**保存了条件码，CPU优先级，模式(用户态和内核态)。

   用户态就算将程序状态字设为内核态，也禁止使用IO或内存等指令。用户态需要系统调用陷入内核并使用操作系统，使用TRAP命令可以完成该功能。注意，使用的是陷入，而不是某个指令，例如被零除出现异常，导致操作系统获得控制权。
   
   每个CPU都有一套指令集，所以x86处理器不能执行ARM程序。
   
   计算机使用流水线式读取指令，在时间复用的系统时，读取，解码，运行都是分步骤运行，一次执行多个命令(流水线)。
   
2. 存储器

   理想情况下，存储器应该快速执行一条指令，这样就不会拖累CPU，并且容量大，便宜。

   ![image-20210828165128212](..\image\image-20210828165128212.png)

   高速缓存行被划分为高速缓存行，典型大小64字节，0-63字节为一行，64-127为一行，以此类推。高速缓存也划分多级，L1缓存总是在CPU中，L2缓存根据不同实现，被决定是否共享。

3. IO设备

   IO设备一般包括设备控制器和设备本身。设备控制器多种多样，就需要不同的软件进行控制(驱动)，由厂家提供对应系统的驱动。
   
   用户发出一个系统调用，内核将其翻译为一个对应设备的驱动程序的调用，驱动程序启动IO在一个连续不断的循环中检查该设备是否完成工作，这种方式叫做**忙等待**。另一种是在设备完成后发出**中断**通知完成。
   
   如果接受中断，CPU会进入用户态，源总线上的设备编号称为中断向量，用于寻找设备中断处理程序地址，原程序会将计数器和PSW压入堆栈，处理完中断后会继续执行原下一条命令。
   
   CPU可以关闭并稍后处理中断，关闭时，发出中断信号的设备可以继续保持中断，在中断再次启用时，如果有多个中断信号，可根据优先级选择性处理。
   
4. 总线

   总线用于传输各部件数据，早期都是**共享总线架构**，即多个设备共用一些总线，因此在传输时就需要仲裁器来决定传输哪个设备的数据。**并行总线架构**，即将32二位的数据用32条总线发送。还有**串行总线架构**，类似于通过链路发送网络包。

## 1.2 操作系统概念

1. 进程

   进程本质上是正在执行的程序，与每个进程相关的就是地址空间，就是存储位置列表。进程是一个容纳程序运行所需要的所有信息。
